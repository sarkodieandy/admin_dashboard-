<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard ‚Ä¢ Finger Licking Admin</title>
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/pages.css" />
  <script src="../env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">Finger Licking</div>
      <div class="nav"></div>
    </aside>
    <main>
      <div class="topbar">
        <div>
          <div id="pageTitle" class="font-bold">Dashboard</div>
          <div class="muted" style="font-size: var(--text-sm)">Overview</div>
        </div>
        <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
          <select id="branchSwitcherSelect" class="input" style="height:38px; width:180px; padding-right:32px;"></select>
          <button class="btn ghost" title="Search">üîç</button>
          <button class="btn ghost" id="notifBtn" title="Notifications" aria-label="Notifications"></button>
          <div style="width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg,#60a5fa,#2563eb); display:grid; place-items:center; color:white; font-weight:700;">A</div>
        </div>
      </div>
      <div class="page page-enter">
        <div class="kpi-grid" id="kpiGrid">
          <div class="kpi-card">
            <div class="muted text-sm">Today's Orders</div>
            <div style="display:flex; align-items:center; gap:12px; margin-top:4px;">
              <div id="kpi-orders" class="text-2xl font-extrabold">‚Äî</div>
              <span class="tag success" id="kpi-orders-trend">New</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="muted text-sm">Revenue</div>
            <div style="display:flex; align-items:center; gap:12px; margin-top:4px;">
              <div id="kpi-revenue" class="text-2xl font-extrabold">‚Äî</div>
              <span class="tag info" id="kpi-revenue-trend">‚ñ≤</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="muted text-sm">Avg Delivery Time</div>
            <div style="display:flex; align-items:center; gap:12px; margin-top:4px;">
              <div id="kpi-time" class="text-2xl font-extrabold">‚Äî</div>
              <span class="tag warning">ETA</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="muted text-sm">Active Chats</div>
            <div id="kpi-chats" class="text-2xl font-extrabold" style="margin-top:4px;">‚Äî</div>
          </div>
          <div class="kpi-card">
            <div class="muted text-sm">Cancellations</div>
            <div id="kpi-cancel" class="text-2xl font-extrabold" style="margin-top:4px;">‚Äî</div>
          </div>
        </div>

        <div class="layout-shell" style="margin-top: var(--space-4); gap: var(--space-4); align-items: flex-start;">
          <div class="card" style="flex:1;">
            <div class="flex-between" style="margin-bottom: var(--space-3);">
              <div>
                <div class="font-bold">Recent Orders</div>
                <div class="muted text-sm">Latest activity</div>
              </div>
              <a class="btn ghost" href="orders.html">View all</a>
            </div>
            <div id="recentOrders" class="space-y-2"></div>
          </div>
          <div class="card" style="width: 420px;">
            <div class="font-bold" style="margin-bottom: var(--space-3);">Orders by Hour (today)</div>
            <canvas id="ordersChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div id="toast" class="toast"></div>
  <script type="module">
    import { renderSidebar, showToast, mountThemeToggle } from "../js/ui.js";
    import { requireAuth, getClient } from "../js/auth.js";
    import { fetchRecentOrders } from "../js/api.js";
    import { fmtMoney, statusLabel, debug } from "../js/utils.js";
    import { mountNotifications } from "../js/notifications_ui.js";
    import { initBranchState, registerBranchSwitcher, onBranchChange, getSelectedBranchId } from "../js/branches.js";

    renderSidebar("dashboard.html");
    mountThemeToggle();
    const { profile } = await requireAuth();
    const supabase = getClient();
    mountNotifications({ supabase });

    await initBranchState({ role: profile.role, profileBranchId: profile.branch_id });
    registerBranchSwitcher(document.getElementById("branchSwitcherSelect"), { allowAll: profile.role === "super_admin" });
    onBranchChange(() => {
      loadKpis();
      loadRecent();
      drawChart();
    });

    loadKpis();
    loadRecent();
    drawChart();

    async function loadKpis() {
      const rawBranch = getSelectedBranchId();
      const branchId = rawBranch && rawBranch !== "all" ? rawBranch : null;
      const today = new Date(); today.setHours(0,0,0,0);
      let q = supabase.from("orders").select("total,status,branch_id").gte("created_at", today.toISOString());
      if (branchId) q = q.eq("branch_id", branchId);
      const { data, error } = await q;
      if (error) debug("kpi orders error", error);
      const orders = data?.length || 0;
      const revenue = data?.reduce((s,o)=>s+Number(o.total||0),0)||0;
      const cancel = data?.filter(o=>o.status==='cancelled').length || 0;
      document.getElementById("kpi-orders").textContent = orders;
      document.getElementById("kpi-revenue").textContent = fmtMoney(revenue);
      document.getElementById("kpi-cancel").textContent = cancel;
      let chatsQ = supabase.from("chats").select("id,branch_id");
      if (branchId) chatsQ = chatsQ.eq("branch_id", branchId);
      const { data: chats, error: chatErr } = await chatsQ;
      if (chatErr) debug("kpi chats error", chatErr);
      document.getElementById("kpi-chats").textContent = chats?.length || 0;
      document.getElementById("kpi-time").textContent = "28 min";
    }

    async function loadRecent() {
      const rawBranch = getSelectedBranchId();
      const branchId = rawBranch && rawBranch !== "all" ? rawBranch : null;
      const list = document.getElementById("recentOrders");
      list.innerHTML = `<div class="skeleton" style="height:40px; border-radius:var(--radius-sm);"></div>`;
      const { data, error } = await fetchRecentOrders({ limit: 12, branchId: rawBranch });
      if (error) { list.innerHTML = `<div class="muted">Error: ${error.message}</div>`; return; }
      if (!data || data.length===0) { list.innerHTML = `<div class="muted">No orders yet.</div>`; return; }
      list.innerHTML = data.map(o=>`
        <div class="flex-between" style="padding:12px; border:1px solid var(--color-border); border-radius: var(--radius-sm); background:var(--color-panel); box-shadow: var(--shadow-xs);">
          <div style="display:flex; gap:12px; align-items:center;">
            <div style="width:34px; height:34px; border-radius:50%; background:#e2e8f0; display:grid; place-items:center; font-weight:800;">${o.id.slice(0,1).toUpperCase()}</div>
            <div>
              <div class="font-semibold">#${o.id.slice(0,8)}</div>
              <div class="muted text-sm">${new Date(o.created_at).toLocaleString()}</div>
            </div>
          </div>
          <div class="chip" style="background:${statusColor(o.status)}; color:#0f172a;">${statusLabel(o.status)}</div>
          <div class="font-bold">${fmtMoney(o.total)}</div>
        </div>`).join("");
    }

    function statusColor(s) {
      const map = {
        placed: "#e5edff",
        confirmed: "#dbeafe",
        preparing: "#fef3c7",
        ready: "#dcfce7",
        en_route: "#e0f2fe",
        delivered: "#dcfce7",
        cancelled: "#fee2e2",
      };
      return map[s] || "#e2e8f0";
    }

    async function drawChart() {
      const rawBranch = getSelectedBranchId();
      const branchId = rawBranch && rawBranch !== "all" ? rawBranch : null;
      const today = new Date(); today.setHours(0,0,0,0);
      let q = supabase.from("orders").select("created_at,branch_id").gte("created_at", today.toISOString());
      if (branchId) q = q.eq("branch_id", branchId);
      const { data, error } = await q;
      if (error) debug("chart error", error);
      const buckets = Array.from({length:24},(_,h)=>({h, c:0}));
      (data||[]).forEach(o=>{
        const hour = new Date(o.created_at).getHours();
        buckets[hour].c++;
      });
      const ctx = document.getElementById("ordersChart");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: buckets.map(b=>b.h),
          datasets: [{ label:"Orders", data: buckets.map(b=>b.c), backgroundColor:"#3b82f6" }]
        },
        options: { plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true} } }
      });
    }
  </script>
</body>
</html>

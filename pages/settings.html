<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings • Finger Licking Admin</title>
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <script src="../env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">Finger Licking</div>
      <div class="nav"></div>
    </aside>
    <main>
      <div class="topbar">
        <div>
          <div class="font-bold">Settings</div>
          <div class="muted" style="font-size: var(--text-sm)">Business rules & preferences</div>
        </div>
        <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
          <button class="btn ghost" id="notifBtn" title="Notifications" aria-label="Notifications"></button>
          <select id="branchSwitcherSelect" class="input" style="height:38px; width:180px; padding-right:32px;"></select>
        </div>
      </div>
      <div class="page">
        <div class="card" style="margin-bottom:14px;">
          <div class="flex-between" style="gap:10px;">
            <div>
              <div class="font-semibold">Sync status</div>
              <div class="muted text-sm" id="syncStatus">Loading…</div>
            </div>
            <label class="chip-btn" id="toggleDebug">Debug off</label>
          </div>
        </div>
        <div class="card-grid">
          <div class="card">
            <div class="font-bold" style="margin-bottom: var(--space-2);">Restaurant / Branch</div>
            <label class="label">Restaurant name</label>
            <input id="restName" class="input" placeholder="Finger Licking Restaurant" />
            <label class="label" style="margin-top:8px;">Phone</label>
            <input id="restPhone" class="input" placeholder="+233..." />
            <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
              <label class="chip-btn" id="toggleOpen">Open</label>
              <label class="chip-btn" id="toggleBusy">Busy mode</label>
            </div>
            <textarea id="busyNote" class="input" rows="2" placeholder="High demand, expect delays" style="margin-top:8px;"></textarea>
            <button class="btn primary" id="saveBusiness" style="margin-top:10px;">Save business</button>
          </div>

          <div class="card">
            <div class="font-bold" style="margin-bottom: var(--space-2);">Operating hours</div>
            <label class="label">Open</label>
            <input id="openTime" class="input" type="time" />
            <label class="label" style="margin-top:6px;">Close</label>
            <input id="closeTime" class="input" type="time" />
            <small class="muted">Split hours & holidays can be added later.</small>
            <button class="btn primary" id="saveHours" style="margin-top:10px;">Save hours</button>
          </div>

          <div class="card">
            <div class="font-bold" style="margin-bottom: var(--space-2);">Order settings</div>
            <label class="label">Minimum order amount</label>
            <input id="minOrder" class="input" type="number" step="0.01" />
            <label class="label" style="margin-top:6px;">Auto-cancel unpaid after (minutes)</label>
            <input id="autoCancel" class="input" type="number" min="0" />
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <label class="chip-btn" id="toggleDelivery">Delivery enabled</label>
              <label class="chip-btn" id="togglePickup">Pickup enabled</label>
              <label class="chip-btn" id="toggleSchedule">Scheduled orders</label>
            </div>
            <button class="btn primary" id="saveOrders" style="margin-top:10px;">Save order rules</button>
          </div>

          <div class="card">
            <div class="font-bold" style="margin-bottom: var(--space-2);">Delivery settings (global)</div>
            <label class="label">Base delivery fee</label>
            <input id="baseFee" class="input" type="number" step="0.01" />
            <label class="label" style="margin-top:6px;">Free radius (km)</label>
            <input id="freeRadius" class="input" type="number" step="0.1" />
            <label class="label" style="margin-top:6px;">Per km fee after free radius</label>
            <input id="perKm" class="input" type="number" step="0.01" />
            <label class="label" style="margin-top:6px;">Max distance (km)</label>
            <input id="maxDistance" class="input" type="number" step="0.1" />
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <label class="chip-btn" id="toggleCOD">Cash on delivery (local only)</label>
            </div>
            <button class="btn primary" id="saveDelivery" style="margin-top:10px;">Save delivery settings</button>
          </div>

          <div class="card">
            <div class="font-bold" style="margin-bottom: var(--space-2);">Notifications & Chat</div>
            <label class="label">Sound alerts</label>
            <label class="chip-btn" id="toggleSound">Sound on</label>
            <label class="label" style="margin-top:6px;">Auto-close chat after delivery (hours)</label>
            <input id="chatClose" class="input" type="number" min="0" />
            <label class="label" style="margin-top:6px;">Profanity filter</label>
            <label class="chip-btn" id="toggleProfanity">Filter on</label>
            <button class="btn primary" id="saveNotify" style="margin-top:10px;">Save notifications</button>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="font-bold" style="margin-bottom: var(--space-2);">Permissions</div>
          <div class="muted text-sm">Settings are intended for admin/owner. Staff access should be restricted.</div>
        </div>
      </div>
    </main>
  </div>
  <script type="module">
    import { renderSidebar, showToast } from "../js/ui.js";
    import { requireAuth } from "../js/auth.js";
    import { loadDeliverySettingsForBranch, saveDeliverySettingsForBranch, loadRestaurantSettingsForBranch, saveRestaurantSettingsForBranch } from "../js/api.js";
    import { createClient } from "../js/supabaseClient.js";
    import { mountNotifications } from "../js/notifications_ui.js";
    import { debugEnabled } from "../js/utils.js";
    import { initBranchState, registerBranchSwitcher, getSelectedBranchId } from "../js/branches.js";

    renderSidebar("settings.html");
    const supabase = createClient();
    const { profile } = await requireAuth();
    mountNotifications({ supabase });
    await initBranchState({ role: profile.role, profileBranchId: profile.branch_id });
    registerBranchSwitcher(document.getElementById("branchSwitcherSelect"), { allowAll: false });

    const stateKey = "adminSettingsLocal";
    const state = JSON.parse(localStorage.getItem(stateKey) || "{}");
    const syncStatus = document.getElementById("syncStatus");

    const bindToggle = (id, key, labelOn = "On", labelOff = "Off") => {
      const el = document.getElementById(id);
      const update = () => {
        const active = !!state[key];
        el.classList.toggle("active", active);
        el.textContent = active ? labelOn : labelOff;
      };
      el.addEventListener("click", () => {
        state[key] = !state[key];
        update();
      });
      update();
    };

    // Bind toggles
    bindToggle("toggleOpen", "isOpen", "Open", "Closed");
    bindToggle("toggleBusy", "isBusy", "Busy", "Normal");
    bindToggle("toggleDelivery", "delivery", "Delivery on", "Delivery off");
    bindToggle("togglePickup", "pickup", "Pickup on", "Pickup off");
    bindToggle("toggleSchedule", "schedule", "Scheduled on", "Scheduled off");
    bindToggle("toggleCOD", "cod", "COD on", "COD off");
    bindToggle("toggleSound", "sound", "Sound on", "Sound off");
    bindToggle("toggleProfanity", "profanity", "Filter on", "Filter off");

    // Debug toggle (client console logs)
    const debugBtn = document.getElementById("toggleDebug");
    const updateDebug = () => {
      const on = debugEnabled();
      debugBtn.classList.toggle("active", on);
      debugBtn.textContent = on ? "Debug on" : "Debug off";
    };
    debugBtn.addEventListener("click", () => {
      localStorage.setItem("admin_debug", debugEnabled() ? "0" : "1");
      updateDebug();
      showToast("Debug logging updated");
    });
    updateDebug();

    const setVal = (id, key) => {
      const el = document.getElementById(id);
      if (state[key]) el.value = state[key];
    };
    setVal("restName", "restName");
    setVal("restPhone", "restPhone");
    setVal("busyNote", "busyNote");
    setVal("openTime", "openTime");
    setVal("closeTime", "closeTime");
    setVal("autoCancel", "autoCancel");
    setVal("chatClose", "chatClose");

    document.getElementById("saveBusiness").addEventListener("click", () => {
      state.restName = document.getElementById("restName").value;
      state.restPhone = document.getElementById("restPhone").value;
      state.busyNote = document.getElementById("busyNote").value;
      persist();
      saveCloud();
    });

    document.getElementById("saveHours").addEventListener("click", () => {
      state.openTime = document.getElementById("openTime").value;
      state.closeTime = document.getElementById("closeTime").value;
      persist();
      saveCloud();
    });

    document.getElementById("saveOrders").addEventListener("click", () => {
      state.autoCancel = document.getElementById("autoCancel").value;
      persist();
      saveCloud();
    });

    document.getElementById("saveNotify").addEventListener("click", () => {
      state.chatClose = document.getElementById("chatClose").value;
      persist();
      saveCloud();
    });

    // Delivery settings persisted to Supabase delivery_settings singleton table
    loadDeliverySettingsForBranch(getSelectedBranchId()).then(({ data }) => {
      if (data) {
        document.getElementById("minOrder").value = data.minimum_order_amount ?? "";
        document.getElementById("baseFee").value = data.base_fee ?? "";
        document.getElementById("freeRadius").value = data.free_radius_km ?? "";
        document.getElementById("perKm").value = data.per_km_fee_after_free_radius ?? "";
        document.getElementById("maxDistance").value = data.max_delivery_distance_km ?? "";
      }
    });

    document.getElementById("saveDelivery").addEventListener("click", async () => {
      const branchId = getSelectedBranchId();
      const payload = {
        base_fee: Number(document.getElementById("baseFee").value || 0),
        free_radius_km: Number(document.getElementById("freeRadius").value || 0),
        per_km_fee_after_free_radius: Number(document.getElementById("perKm").value || 0),
        max_delivery_distance_km: Number(document.getElementById("maxDistance").value || 0),
        minimum_order_amount: Number(document.getElementById("minOrder").value || 0),
      };
      const { error } = await saveDeliverySettingsForBranch(payload, branchId);
      if (error) return showToast(error.message);
      showToast("Delivery settings saved");
    });

    await loadCloud();

    async function loadCloud() {
      const branchId = getSelectedBranchId();
      syncStatus.textContent = "Checking cloud settings…";
      const res = await loadRestaurantSettingsForBranch(branchId);
      if (res?.missing) {
        syncStatus.textContent = "Local only (apply migration to enable cloud sync)";
        return;
      }
      if (res?.error) {
        syncStatus.textContent = `Cloud error: ${res.error.message}`;
        return;
      }
      if (res?.data) {
        // Map DB -> local state (camel-ish keys)
        state.restName = res.data.rest_name ?? state.restName;
        state.restPhone = res.data.rest_phone ?? state.restPhone;
        state.isOpen = res.data.is_open ?? state.isOpen;
        state.isBusy = res.data.is_busy ?? state.isBusy;
        state.busyNote = res.data.busy_note ?? state.busyNote;
        state.openTime = res.data.open_time ?? state.openTime;
        state.closeTime = res.data.close_time ?? state.closeTime;
        state.autoCancel = res.data.auto_cancel_min ?? state.autoCancel;
        state.chatClose = res.data.chat_close_hours ?? state.chatClose;
        state.delivery = res.data.delivery_enabled ?? state.delivery;
        state.pickup = res.data.pickup_enabled ?? state.pickup;
        state.schedule = res.data.scheduled_orders_enabled ?? state.schedule;
        state.cod = res.data.cash_on_delivery_enabled ?? state.cod;
        state.sound = res.data.sound_alerts ?? state.sound;
        state.profanity = res.data.profanity_filter ?? state.profanity;
        persist();
        // Re-apply values after merge
        setVal("restName", "restName");
        setVal("restPhone", "restPhone");
        setVal("busyNote", "busyNote");
        setVal("openTime", "openTime");
        setVal("closeTime", "closeTime");
        setVal("autoCancel", "autoCancel");
        setVal("chatClose", "chatClose");
        syncStatus.textContent = "Synced from cloud";
      } else {
        syncStatus.textContent = "Cloud sync ready (no settings saved yet)";
      }
    }

    async function saveCloud() {
      const branchId = getSelectedBranchId();
      syncStatus.textContent = "Saving…";
      const payload = {
        rest_name: document.getElementById("restName").value || null,
        rest_phone: document.getElementById("restPhone").value || null,
        busy_note: document.getElementById("busyNote").value || null,
        open_time: document.getElementById("openTime").value || null,
        close_time: document.getElementById("closeTime").value || null,
        auto_cancel_min: Number(document.getElementById("autoCancel").value || 0),
        chat_close_hours: Number(document.getElementById("chatClose").value || 0),
        is_open: !!state.isOpen,
        is_busy: !!state.isBusy,
        delivery_enabled: !!state.delivery,
        pickup_enabled: !!state.pickup,
        scheduled_orders_enabled: !!state.schedule,
        cash_on_delivery_enabled: !!state.cod,
        sound_alerts: !!state.sound,
        profanity_filter: !!state.profanity,
      };
      const res = await saveRestaurantSettingsForBranch(payload, branchId);
      if (res?.missing) {
        syncStatus.textContent = "Saved locally (cloud table missing)";
        showToast("Saved (local)");
        return;
      }
      if (res?.error) {
        syncStatus.textContent = `Save failed: ${res.error.message}`;
        showToast(res.error.message);
        return;
      }
      syncStatus.textContent = "Saved to cloud";
      showToast("Saved");
    }

    function persist() {
      localStorage.setItem(stateKey, JSON.stringify(state));
    }
  </script>
</body>
</html>

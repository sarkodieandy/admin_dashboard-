<!doctype html>
<html lang="en">
  <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Riders • Finger Licking Admin</title>
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <script src="../env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
  <style>
    .riders-hero {
      margin-bottom: var(--space-3);
      border-radius: var(--radius-lg);
      padding: 22px;
      background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(14,165,233,0.08));
      border: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }
    .riders-hero__actions {
      display: flex;
      gap: 8px;
    }
    .riders-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: var(--space-3);
    }
    .stat-card {
      padding: 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      background: var(--color-panel);
      box-shadow: var(--shadow-xs);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .stat-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-muted);
    }
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
    }
    .riders-table-card {
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow-xs);
    }
    .riders-table__header {
      margin-bottom: var(--space-2);
    }
    .branch-switcher {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      font-size: 12px;
      gap: 4px;
      color: var(--color-muted);
    }
    .branch-switcher select {
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--color-border);
      background: var(--color-panel);
      padding: 0 10px;
      font-size: 14px;
      min-width: 200px;
    }
    @media (max-width: 720px) {
      .riders-hero {
        flex-direction: column;
      }
      .riders-hero__actions {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">Finger Licking</div>
      <div class="nav"></div>
    </aside>
    <main>
      <div class="topbar">
        <div>
          <div class="font-bold">Riders</div>
          <div class="muted" style="font-size: var(--text-sm)">Track & update rider contacts</div>
        </div>
        <div style="margin-left:auto; display:flex; align-items:center; gap:12px;">
          <div class="branch-switcher">
            <label for="branchSwitcherSelect">Branch</label>
            <select id="branchSwitcherSelect"></select>
          </div>
          <button class="btn ghost" id="notifBtn" title="Notifications" aria-label="Notifications"></button>
          <button class="btn primary" id="refreshRiders">Reload</button>
        </div>
      </div>
      <div class="page">
        <div class="riders-hero">
          <div>
            <div class="font-semibold" style="font-size:1.3rem;">Manage rider dispatch</div>
            <div class="muted text-sm">Create rider profiles here so admins can assign them to orders and surface their info in tracking.</div>
          </div>
          <div class="riders-hero__actions">
            <button class="btn ghost" id="openRiderHint">Need help?</button>
            <button class="btn primary" id="addRiderBtn">Add rider</button>
          </div>
        </div>
        <div class="riders-stats">
          <div class="stat-card">
            <div class="stat-label">Active</div>
            <div class="stat-value" id="statActive">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Inactive</div>
            <div class="stat-value" id="statInactive">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total riders</div>
            <div class="stat-value" id="statTotal">0</div>
          </div>
        </div>
        <div class="card riders-table-card">
          <div class="flex-between riders-table__header">
            <div>
              <div class="font-semibold">Riders</div>
              <div class="muted text-sm">Names, phones, vehicles, and availability.</div>
            </div>
            <span class="badge-dot" aria-hidden="true"></span>
          </div>
          <table class="table" id="ridersTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Vehicle</th>
                <th>Status</th>
                <th>Added</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
<div class="modal-backdrop" id="riderModal">
  <div class="modal">
    <header>
      <div>
        <div class="font-semibold" id="riderModalTitle">Edit rider</div>
        <div class="muted text-sm" id="riderModalSubtitle"></div>
      </div>
      <button class="btn ghost" id="closeRiderModal">✕</button>
    </header>
    <form id="riderForm">
      <label class="label">Name</label>
      <input class="input" id="riderName" required />
      <label class="label">Phone</label>
      <input class="input" id="riderPhone" />
      <label class="label">Vehicle type</label>
      <select class="input" id="riderVehicle">
        <option value="">Select vehicle</option>
        <option value="bike">Bike</option>
        <option value="car">Car</option>
        <option value="other">Other</option>
      </select>
      <label class="label" style="display:flex; align-items:center; gap:10px;">
        <input type="checkbox" id="riderActive" />
        <span>Active rider</span>
      </label>
      <label class="label">Delivery notes</label>
      <textarea class="input" id="riderNote" rows="3" placeholder="Optional reminder for kitchen/rider"></textarea>
      <button class="btn primary" type="submit">Save rider</button>
    </form>
  </div>
</div>
  <script type="module">
    import { renderSidebar, showToast, mountThemeToggle } from "../js/ui.js";
    import { requireAuth, getClient } from "../js/auth.js";
    import { fmtDateTime } from "../js/utils.js";
    import { fetchRiders, updateRider, insertRider } from "../js/api.js";
    import { mountNotifications } from "../js/notifications_ui.js";
    import { initBranchState, registerBranchSwitcher, getSelectedBranchId, onBranchChange } from "../js/branches.js";

    renderSidebar("riders.html");
    mountThemeToggle();
    const { profile } = await requireAuth();
    const supabase = getClient();
    mountNotifications({ supabase });
    await initBranchState({ role: profile.role, profileBranchId: profile.branch_id });
    registerBranchSwitcher(document.getElementById("branchSwitcherSelect"), {
      allowAll: profile.role === "super_admin",
    });
    onBranchChange(() => load());

    const tbody = document.querySelector("#ridersTable tbody");
    const riderModal = document.getElementById("riderModal");
    const riderForm = document.getElementById("riderForm");
    const riderName = document.getElementById("riderName");
    const riderPhone = document.getElementById("riderPhone");
    const riderVehicle = document.getElementById("riderVehicle");
    const riderActive = document.getElementById("riderActive");
    const riderNote = document.getElementById("riderNote");
    const riderSubtitle = document.getElementById("riderModalSubtitle");
    const riderModalTitle = document.getElementById("riderModalTitle");
    const statActive = document.getElementById("statActive");
    const statInactive = document.getElementById("statInactive");
    const statTotal = document.getElementById("statTotal");
    let riderMap = new Map();
    let editingRider = null;

    function openRiderModal(title, subtitle, rider) {
      editingRider = rider || null;
      riderModalTitle.textContent = title;
      riderSubtitle.textContent = subtitle;
      riderName.value = rider?.name ?? "";
      riderPhone.value = rider?.phone ?? "";
      riderVehicle.value = rider?.vehicle_type ?? "";
      riderActive.checked = rider?.is_active ?? true;
      riderNote.value = rider?.default_delivery_note ?? "";
      riderModal.classList.add("show");
    }

    document.getElementById("refreshRiders").addEventListener("click", load);
    document.getElementById("addRiderBtn").addEventListener("click", () =>
      openRiderModal("Add rider", "Create a new rider profile", null),
    );
    document.getElementById("openRiderHint").addEventListener("click", () => {
      showToast("Riders are stored in the `riders` table. Add them here so tracking shows their details.");
    });
    document
      .getElementById("closeRiderModal")
      .addEventListener("click", () => riderModal.classList.remove("show"));
    riderModal.addEventListener("click", (event) => {
      if (event.target === riderModal) riderModal.classList.remove("show");
    });

    riderForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const rawBranch = getSelectedBranchId();
      const branchId = rawBranch && rawBranch !== "all" ? rawBranch : null;
      if (!editingRider && !branchId) {
        showToast("Select a branch before creating a rider");
        return;
      }
      const payload = {
        name: riderName.value.trim() || null,
        phone: riderPhone.value.trim() || null,
        vehicle_type: riderVehicle.value || null,
        is_active: riderActive.checked,
        default_delivery_note: riderNote.value.trim() || null,
      };
      if (editingRider) {
        const { error } = await updateRider(editingRider.id, payload);
        if (error) {
          showToast(error.message);
          return;
        }
        showToast("Rider saved");
      } else {
        const { error } = await insertRider({ ...payload, branch_id: branchId });
        if (error) {
          showToast(error.message);
          return;
        }
        showToast("Rider created");
      }
      riderModal.classList.remove("show");
      await load();
    });

    load();

    async function load() {
      tbody.innerHTML = `<tr><td colspan="6"><div class="skeleton" style="height:32px;"></div></td></tr>`;
      const rawBranch = getSelectedBranchId();
      const branchId = rawBranch && rawBranch !== "all" ? rawBranch : null;
      const { data, error } = await fetchRiders({ branchId });
      if (error) {
        tbody.innerHTML = `<tr><td colspan="6" class="muted">Error: ${error.message}</td></tr>`;
        updateStats([]);
        return;
      }
      updateStats(data || []);
      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr class="table-empty">
            <td colspan="6">
              <div class="flex-between" style="gap:12px;">
                <div>
                  <div class="font-semibold">No riders yet</div>
                  <div class="muted text-sm">Create riders so they appear in order tracking.</div>
                </div>
                <button class="btn primary" id="emptyAdd">Add rider</button>
              </div>
            </td>
          </tr>`;
        document.getElementById("emptyAdd")?.addEventListener("click", () => {
          document.getElementById("addRiderBtn")?.click();
        });
        return;
      }
      riderMap = new Map((data || []).map((r) => [r.id, r]));
      tbody.innerHTML = (data || [])
        .map((r) => {
          const note = r.default_delivery_note?.trim() || "No notes";
          const notePreview = note.length > 40 ? `${note.slice(0, 40)}…` : note;
          const statusTag = r.is_active
            ? '<span class="chip success">Active</span>'
            : '<span class="chip muted">Inactive</span>';
          return `
            <tr data-id="${r.id}">
              <td>
                <div class="font-semibold">${escapeHtml(r.name || "Rider")}</div>
                <div class="muted text-xs">Created ${fmtDateTime(r.created_at || "")}</div>
              </td>
              <td>${escapeHtml(r.phone || "—")}</td>
              <td>${escapeHtml(r.vehicle_type || "Unspecified")}</td>
              <td>
                <div style="display:flex; align-items:center; gap:6px;">${statusTag}</div>
                <div class="muted text-xs">${escapeHtml(notePreview)}</div>
              </td>
              <td><span class="muted text-sm">Updated ${fmtDateTime(r.created_at || "")}</span></td>
              <td>
                <button class="btn ghost" data-edit-rider="${r.id}">Edit</button>
              </td>
            </tr>`;
        })
        .join("");
      tbody.querySelectorAll("[data-edit-rider]").forEach((button) => {
        button.addEventListener("click", () => {
          const rider = riderMap.get(button.dataset.editRider);
          if (!rider) return;
          openRiderModal(
            `Edit rider ${rider.name?.split(" ").shift() || "profile"}`,
            `Vehicle: ${rider.vehicle_type || "Unspecified"} • ${rider.is_active ? "Active" : "Inactive"} • Created ${fmtDateTime(
              rider.created_at || "",
            )}`,
            rider,
          );
        });
      });
    }

    function escapeHtml(value) {
      return String(value || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function updateStats(riders = []) {
      const list = riders || [];
      const total = list.length;
      const active = list.filter((r) => r.is_active).length;
      statActive.textContent = active;
      statInactive.textContent = Math.max(total - active, 0);
      statTotal.textContent = total;
    }
  </script>
</body>
</html>

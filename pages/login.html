<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finger Licking Admin â€“ Login</title>
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/pages.css" />
  <script src="../env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="layout" style="grid-template-columns: 1fr; min-height:100vh;">
    <main style="display:flex; align-items:center; justify-content:center; padding:20px;">
      <div class="card" style="max-width:380px; width:100%; padding:24px;">
        <div class="flex-between">
          <div>
            <div class="font-extrabold" style="font-size:20px; letter-spacing:0.2px;">Finger Licking</div>
            <div class="muted text-sm">Admin sign in</div>
          </div>
          <button class="btn ghost icon-btn" id="themeBtn" type="button" title="Toggle theme" aria-label="Toggle theme">ðŸŒ“</button>
        </div>

        <div id="fileWarn" class="card" style="margin-top:14px; padding:12px; box-shadow:none; border:1px solid rgba(245,158,11,0.35); background: rgba(245,158,11,0.08); display:none;">
          <div class="font-semibold">You opened this from your files.</div>
          <div class="muted text-sm">This dashboard must be served over HTTP (modules wonâ€™t load on <code>file://</code>).</div>
          <div class="muted text-sm" style="margin-top:6px;">Run: <code>python3 -m http.server 5173</code> then open <code>http://localhost:5173/admin-dashboard/</code></div>
        </div>

        <p class="muted" style="margin:14px 0 16px 0;">Staff/Admin accounts only.</p>
        <form id="loginForm" class="space-y">
          <div style="display:flex; flex-direction:column; gap:6px;">
            <label class="label" for="email">Email</label>
            <input id="email" name="email" type="email" required class="input" autocomplete="email" />
          </div>
          <div style="display:flex; flex-direction:column; gap:6px;">
            <label class="label" for="password">Password</label>
            <input id="password" name="password" type="password" required class="input" autocomplete="current-password" />
          </div>
          <button class="btn primary" id="submitBtn" type="submit" style="width:100%;">
            <span id="submitLabel">Sign in</span>
          </button>
        </form>
        <div id="loginError" class="muted text-sm" style="margin-top:10px; color: var(--color-danger); min-height: 18px;"></div>
        <div class="muted text-xs" style="margin-top:12px;">
          If you canâ€™t sign in, ask an admin to allowlist your email in <strong>Staff & Roles</strong>.
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { createClient } from "../js/supabaseClient.js";
    import { showToast, mountThemeToggle } from "../js/ui.js";
    const supabase = createClient();
    const form = document.getElementById("loginForm");
    const errorEl = document.getElementById("loginError");
    const submitBtn = document.getElementById("submitBtn");
    const submitLabel = document.getElementById("submitLabel");

    mountThemeToggle();
    document.getElementById("themeBtn").addEventListener("click", () => {
      document.getElementById("themeToggle")?.click?.();
    });

    // Warn when opened via file:// (modules + imports will be blocked)
    if (location.protocol === "file:") {
      document.getElementById("fileWarn").style.display = "block";
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorEl.textContent = "";
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!email || !password) {
        errorEl.textContent = "Enter your email and password.";
        return;
      }

      submitBtn.classList.add("loading");
      submitBtn.disabled = true;
      submitLabel.innerHTML = `<span class="spinner" aria-hidden="true"></span> Signing inâ€¦`;

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        errorEl.textContent = error.message;
        submitBtn.classList.remove("loading");
        submitBtn.disabled = false;
        submitLabel.textContent = "Sign in";
        return;
      }

      // Ensure staff-only access is clear (no confusing redirect loops).
      const { data: sessionData } = await supabase.auth.getSession();
      const userId = sessionData?.session?.user?.id;
      if (userId) {
        const { data: profile } = await supabase.from("profiles").select("role").eq("id", userId).maybeSingle();
        if (profile?.role && !["admin", "staff"].includes(profile.role)) {
          await supabase.auth.signOut();
          errorEl.textContent = "This account is not staff/admin. Ask admin to allowlist your email.";
          submitBtn.classList.remove("loading");
          submitBtn.disabled = false;
          submitLabel.textContent = "Sign in";
          return;
        }
      }

      showToast("Signed in");
      window.location.href = "dashboard.html";
    });
  </script>
</body>
</html>

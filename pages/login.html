<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finger Licking Admin ‚Äì Login</title>
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/pages.css" />
  <script src="../env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
  <style>
    .login-shell {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 22px;
      background:
        radial-gradient(1200px 700px at 15% 15%, rgba(59,130,246,0.26), transparent 55%),
        radial-gradient(980px 640px at 85% 35%, rgba(249,115,22,0.22), transparent 58%),
        radial-gradient(820px 520px at 50% 90%, rgba(16,185,129,0.14), transparent 62%),
        #070a10;
    }

    .login-frame {
      width: min(1180px, 100%);
      min-height: 640px;
      border-radius: 24px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.22);
      box-shadow: 0 28px 90px rgba(2, 6, 23, 0.65);
      display: grid;
      grid-template-columns: 0.44fr 0.56fr;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(14px);
    }

    .login-panel {
      padding: 30px 28px 22px 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      background:
        linear-gradient(180deg, rgba(2, 6, 23, 0.82), rgba(2, 6, 23, 0.62)),
        radial-gradient(900px 480px at 10% 10%, rgba(59,130,246,0.22), transparent 60%);
      color: rgba(255,255,255,0.92);
      border-right: 1px solid rgba(148, 163, 184, 0.16);
    }

    .login-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .brand-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-mark {
      height: 44px;
      width: 44px;
      border-radius: 16px;
      display: grid;
      place-items: center;
      background: rgba(255, 255, 255, 0.10);
      border: 1px solid rgba(255, 255, 255, 0.16);
      box-shadow: 0 14px 40px rgba(0,0,0,0.25);
    }

    .brand-mark svg { width: 28px; height: 28px; }

    .brand-title {
      margin: 0;
      font-size: 26px;
      line-height: 1.1;
      font-weight: 900;
      letter-spacing: -0.4px;
    }

    .brand-subtitle {
      margin: 6px 0 0 0;
      font-size: 13px;
      color: rgba(255,255,255,0.72);
      line-height: 1.35;
    }

    .panel-divider {
      height: 1px;
      background: rgba(148, 163, 184, 0.16);
    }

    .section-title {
      margin: 0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -0.2px;
    }

    .role-picker {
      display: grid;
      gap: 10px;
    }

    .role-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.86);
      cursor: pointer;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }

    .role-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,0.08); }

    .role-btn.active {
      background: linear-gradient(90deg, rgba(249,115,22,0.28), rgba(249,115,22,0.10));
      border-color: rgba(249,115,22,0.55);
      box-shadow: 0 18px 50px rgba(249,115,22,0.12);
    }

    .role-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .role-icon {
      width: 36px;
      height: 36px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      flex: 0 0 auto;
    }

    .role-label {
      font-size: 16px;
      font-weight: 850;
      letter-spacing: -0.15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .role-check {
      opacity: 0;
      transform: translateY(1px);
      transition: opacity 120ms ease;
      font-weight: 900;
    }
    .role-btn.active .role-check { opacity: 1; }

    .field {
      display: grid;
      gap: 8px;
    }

    .input-wrap {
      position: relative;
      display: grid;
      align-items: center;
    }

    .input-wrap .input {
      height: 44px;
      padding-left: 42px;
      background: rgba(255,255,255,0.06);
      border-color: rgba(148, 163, 184, 0.22);
      color: rgba(255,255,255,0.92);
    }

    .input-wrap .input::placeholder { color: rgba(255,255,255,0.55); }

    .input-wrap .lead {
      position: absolute;
      left: 12px;
      color: rgba(255,255,255,0.70);
    }

    .panel-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .link {
      color: rgba(255,255,255,0.72);
      font-size: 13px;
      border: 0;
      background: transparent;
      padding: 0;
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .link:hover { color: rgba(255,255,255,0.88); }

    .login-primary {
      width: 100%;
      height: 52px;
      border-radius: 14px;
      border: 1px solid rgba(249,115,22,0.55);
      background: linear-gradient(90deg, #f97316, #fb923c);
      color: #0b1220;
      font-weight: 900;
      font-size: 18px;
      box-shadow: 0 20px 50px rgba(249,115,22,0.22);
    }
    .login-primary:hover { filter: brightness(1.02); transform: translateY(-1px); }

    .panel-footer {
      margin-top: auto;
      padding-top: 14px;
      border-top: 1px solid rgba(148, 163, 184, 0.16);
      color: rgba(255,255,255,0.70);
      font-size: 12px;
    }

    .login-visual {
      position: relative;
      overflow: hidden;
      background:
        radial-gradient(1200px 700px at 65% 10%, rgba(147,197,253,0.42), transparent 55%),
        radial-gradient(900px 600px at 90% 80%, rgba(251,146,60,0.28), transparent 55%),
        linear-gradient(180deg, rgba(30, 41, 59, 0.22), rgba(2, 6, 23, 0.25));
    }

    .login-visual::before {
      content: "";
      position: absolute;
      inset: 0;
      background: url("../assets/admin-illustration.svg") no-repeat center bottom / cover;
      opacity: 0.95;
      transform: scale(1.02);
      pointer-events: none;
    }

    .login-visual::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(1000px 600px at 50% 10%, rgba(255,255,255,0.10), transparent 55%);
      pointer-events: none;
    }

    @media (max-width: 980px) {
      .login-frame { grid-template-columns: 1fr; min-height: auto; }
      .login-visual { min-height: 320px; }
      .login-panel { border-right: 0; border-bottom: 1px solid rgba(148, 163, 184, 0.16); }
    }
  </style>
</head>
<body>
  <div class="login-shell">
    <main class="login-frame">
      <section class="login-panel">
        <div class="login-top">
          <div>
            <div class="brand-row">
              <div class="brand-mark" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M4 14c0-4.1 3.6-7 8-7s8 2.9 8 7" stroke="rgba(255,255,255,0.9)" stroke-width="2.2" stroke-linecap="round"/>
                  <path d="M3 16h18c1 0 2 .8 2 1.8S22 20 21 20H3c-1 0-2-.8-2-1.8S2 16 3 16Z" fill="#fb923c"/>
                  <path d="M12 5a2 2 0 0 0-2 2" stroke="#fb923c" stroke-width="2.2" stroke-linecap="round"/>
                </svg>
              </div>
              <div>
                <h1 class="brand-title">Admin Dashboard</h1>
                <p class="brand-subtitle">Manage your restaurant network</p>
              </div>
            </div>
          </div>
          <button class="btn ghost icon-btn" id="themeBtn" type="button" title="Toggle theme" aria-label="Toggle theme">üåì</button>
        </div>

        <div class="panel-divider"></div>

        <div>
          <h2 class="section-title">Select Admin Role</h2>
          <div class="brand-subtitle" style="margin-top:6px;">Access is verified after sign‚Äëin.</div>
        </div>

        <div class="role-picker" id="rolePicker">
          <button class="role-btn" type="button" data-role="staff">
            <span class="role-left">
              <span class="role-icon" aria-hidden="true">üë§</span>
              <span class="role-label">Admin / Staff</span>
            </span>
            <span class="role-check" aria-hidden="true">‚úì</span>
          </button>
          <button class="role-btn" type="button" data-role="branch_admin">
            <span class="role-left">
              <span class="role-icon" aria-hidden="true">üè¨</span>
              <span class="role-label">Branch Admin</span>
            </span>
            <span class="role-check" aria-hidden="true">‚úì</span>
          </button>
          <button class="role-btn active" type="button" data-role="super_admin">
            <span class="role-left">
              <span class="role-icon" aria-hidden="true">üõ°Ô∏è</span>
              <span class="role-label">Super Admin</span>
            </span>
            <span class="role-check" aria-hidden="true">‚úì</span>
          </button>
          <input id="loginAs" name="loginAs" type="hidden" value="super_admin" />
        </div>

        <div id="fileWarn" class="card" style="padding:12px; box-shadow:none; border:1px solid rgba(245,158,11,0.35); background: rgba(245,158,11,0.10); display:none;">
          <div class="font-semibold" style="color: rgba(255,255,255,0.92);">You opened this from your files.</div>
          <div class="muted text-sm" style="color: rgba(255,255,255,0.74);">This dashboard must be served over HTTP (modules won‚Äôt load on <code>file://</code>).</div>
          <div class="muted text-sm" style="margin-top:6px; color: rgba(255,255,255,0.74);">Run: <code>cd admin-dashboard && python3 -m http.server 8000</code> then open <code>http://localhost:8000/pages/login.html</code></div>
        </div>

        <form id="loginForm" class="space-y" style="margin-top: 2px;">
          <div class="field">
            <label class="label" for="email" style="color: rgba(255,255,255,0.72);">Email</label>
            <div class="input-wrap">
              <span class="lead" aria-hidden="true">‚úâÔ∏è</span>
              <input id="email" name="email" type="email" required class="input" autocomplete="email" placeholder="you@company.com" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="password" style="color: rgba(255,255,255,0.72);">Password</label>
            <div class="input-wrap">
              <span class="lead" aria-hidden="true">üîí</span>
              <input id="password" name="password" type="password" required class="input" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>

          <div class="panel-actions">
            <button class="link" id="forgotBtn" type="button">Forgot password?</button>
            <div class="muted text-xs" style="color: rgba(255,255,255,0.58);">Staff only</div>
          </div>

          <button class="login-primary" id="submitBtn" type="submit">
            <span id="submitLabel">Login</span>
          </button>
        </form>

        <div id="loginError" class="muted text-sm" style="margin-top:10px; color: #fb7185; min-height: 18px;"></div>
        <div class="panel-footer">
          ¬© <span id="year"></span> Finger Licking. All rights reserved.
        </div>
      </section>

      <section class="login-visual" aria-hidden="true"></section>
    </main>
  </div>

  <script type="module">
    import { createClient } from "../js/supabaseClient.js";
    import { showToast, mountThemeToggle } from "../js/ui.js";
    const supabase = createClient();
    const form = document.getElementById("loginForm");
    const errorEl = document.getElementById("loginError");
    const submitBtn = document.getElementById("submitBtn");
    const submitLabel = document.getElementById("submitLabel");
    const loginAsEl = document.getElementById("loginAs");

    mountThemeToggle();
    document.getElementById("themeBtn").addEventListener("click", () => {
      document.getElementById("themeToggle")?.click?.();
    });

    // Warn when opened via file:// (modules + imports will be blocked)
    if (location.protocol === "file:") {
      document.getElementById("fileWarn").style.display = "block";
    }

    document.getElementById("year").textContent = String(new Date().getFullYear());

    const roleButtons = Array.from(document.querySelectorAll("#rolePicker .role-btn"));
    function setRole(role) {
      loginAsEl.value = role;
      roleButtons.forEach((b) => b.classList.toggle("active", b.dataset.role === role));
    }
    roleButtons.forEach((b) => b.addEventListener("click", () => setRole(b.dataset.role)));

    document.getElementById("forgotBtn").addEventListener("click", () => {
      showToast("Ask the owner to reset your password.");
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorEl.textContent = "";
      const loginAs = (loginAsEl?.value || "staff").trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!email || !password) {
        errorEl.textContent = "Enter your email and password.";
        return;
      }

      submitBtn.disabled = true;
      submitLabel.textContent = "Signing in‚Ä¶";

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        errorEl.textContent = error.message;
        submitBtn.disabled = false;
        submitLabel.textContent = "Login";
        return;
      }

      // Ensure staff-only access is clear (no confusing redirect loops).
      const { data: sessionData } = await supabase.auth.getSession();
      const userId = sessionData?.session?.user?.id;
      if (userId) {
        const { data: profile } = await supabase.from("profiles").select("role").eq("id", userId).maybeSingle();
        const role = profile?.role;
        const isStaffRole = role && ["staff", "admin", "branch_admin", "super_admin"].includes(role);
        if (!isStaffRole) {
          await supabase.auth.signOut();
          errorEl.textContent = "Access denied. This account is not staff/admin.";
          submitBtn.disabled = false;
          submitLabel.textContent = "Login";
          return;
        }

        // Validate the selected login type against the actual profile role.
        // This does NOT grant access; it only prevents confusing mismatches.
        const normalized = role === "admin" ? "branch_admin" : role;
        if (loginAs === "super_admin" && normalized !== "super_admin") {
          await supabase.auth.signOut();
          errorEl.textContent = "This account is not a Super Admin account.";
          submitBtn.disabled = false;
          submitLabel.textContent = "Login";
          return;
        }
        if (loginAs === "branch_admin" && !["branch_admin", "super_admin"].includes(normalized)) {
          await supabase.auth.signOut();
          errorEl.textContent = "This account is not a Branch Admin account.";
          submitBtn.disabled = false;
          submitLabel.textContent = "Login";
          return;
        }
        if (loginAs === "staff" && !["staff", "branch_admin", "super_admin"].includes(normalized)) {
          await supabase.auth.signOut();
          errorEl.textContent = "This account is not a Staff account.";
          submitBtn.disabled = false;
          submitLabel.textContent = "Login";
          return;
        }
      }

      showToast("Signed in");
      window.location.href = "dashboard.html";
    });
  </script>
</body>
</html>

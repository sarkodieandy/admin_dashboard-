<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Menu • Finger Licking Admin</title>
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/pages.css" />
  <script src="../env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
  <style>
    .branch-switcher {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      font-size: 12px;
      gap: 4px;
      color: var(--color-muted);
    }
    .branch-switcher select {
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--color-border);
      background: var(--color-panel);
      padding: 0 10px;
      font-size: 14px;
      min-width: 200px;
    }
    .branch-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.12);
      color: #0d47a1;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">Finger Licking</div>
      <div class="nav"></div>
    </aside>
    <main>
      <div class="topbar">
        <div>
          <div class="font-bold">Menu</div>
          <div class="muted" style="font-size: var(--text-sm)">Categories • Items • Add-ons</div>
        </div>
        <div style="margin-left:auto; display:flex; gap:12px; align-items:center;">
          <div class="branch-switcher">
            <label for="branchSwitcherSelect">Branch</label>
            <select id="branchSwitcherSelect"></select>
          </div>
          <button class="btn ghost" id="notifBtn" title="Notifications" aria-label="Notifications"></button>
          <button id="addItemBtn" class="btn primary">Add Item</button>
          <button id="addCategoryBtn" class="btn">Add Category</button>
          <button id="addAddonBtn" class="btn">Add Add-on</button>
          <button id="reloadMenu" class="btn ghost">Reload</button>
        </div>
      </div>
      <div class="page" style="display:grid; grid-template-columns: 320px 1fr; gap: var(--space-4); align-items:start;">
        <div class="card" id="categoriesCard">
          <div class="flex-between">
            <div class="font-semibold">Categories</div>
            <small class="muted">Drag to reorder</small>
          </div>
          <div id="catList" class="space-y-2" style="margin-top:12px;"></div>
        </div>

        <div class="card" style="padding:16px; box-shadow:var(--color-shadow);">
	          <div class="flex-between" style="gap:8px; flex-wrap:wrap;">
	            <input id="searchInput" class="input" placeholder="Search item name" style="max-width:220px;">
	            <select id="filterCategory" class="input" style="max-width:180px;">
	              <option value="">All categories</option>
	            </select>
	            <select id="filterAvailability" class="input" style="max-width:160px;">
	              <option value="">All availability</option>
	              <option value="available">Available</option>
	              <option value="soldout">Sold out</option>
	              <option value="inactive">Inactive</option>
	            </select>
	          </div>
	          <div id="itemsTable" class="table-wrap" style="margin-top:16px;">
	            <table class="table">
	              <thead>
	                <tr>
	                  <th>Item</th><th>Category</th><th>Price</th><th>Available</th><th>Active</th><th></th>
	                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="card" style="margin-top:18px; box-shadow:none; border:1px solid var(--color-border);">
            <div class="flex-between">
              <div class="font-semibold">Add-ons</div>
              <button id="refreshAddons" class="btn ghost">Refresh</button>
            </div>
            <div id="addonList" class="space-y-2" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="modal-backdrop" id="itemModal">
    <div class="modal">
      <header><div class="font-semibold" id="itemModalTitle">Add item</div><button class="btn ghost" data-close="itemModal">✕</button></header>
	      <form id="itemForm">
	        <input type="hidden" name="id" />
	        <div>
	          <div class="label">Name</div>
	          <input class="input" name="name" required />
	        </div>
        <div>
          <div class="label">Description</div>
          <textarea class="input" name="description" rows="2"></textarea>
        </div>
        <div class="flex-between" style="gap:8px;">
          <div style="flex:1;">
            <div class="label">Category</div>
            <select class="input" name="category_id" required id="itemCatSelect"></select>
          </div>
          <div style="width:140px;">
            <div class="label">Price</div>
            <input class="input" name="base_price" type="number" step="0.01" required />
          </div>
        </div>
	        <div class="flex-between" style="gap:8px;">
	          <div style="flex:1;">
	            <div class="label">Image</div>
	            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
	              <input class="input" name="image_url" placeholder="Paste image URL (optional)" style="flex:1; min-width:220px;" />
	              <label class="btn secondary" style="white-space:nowrap;">
	                Upload…
	                <input id="itemImageFile" type="file" accept="image/*" style="display:none;" />
	              </label>
	            </div>
	            <div class="muted text-sm" style="margin-top:6px;">
	              Tip: Use upload for best results. Images are stored in Supabase Storage.
	            </div>
	            <div id="itemImagePreview" style="margin-top:10px; display:none; align-items:center; gap:10px;">
	              <img id="itemImagePreviewImg" alt="" style="width:72px; height:72px; object-fit:cover; border-radius:14px; border:1px solid var(--color-border);" />
	              <button class="btn ghost" id="clearItemImage" type="button">Remove image</button>
	            </div>
	          </div>
	          <label style="display:flex; align-items:center; gap:8px;">
	            <input type="checkbox" name="is_sold_out" /> Sold out
	          </label>
	        </div>
        <button class="btn primary" type="submit">Save item</button>
      </form>
    </div>
  </div>

  <div class="modal-backdrop" id="categoryModal">
    <div class="modal">
      <header><div class="font-semibold">Add category</div><button class="btn ghost" data-close="categoryModal">✕</button></header>
      <form id="categoryForm">
        <div class="label">Name</div>
        <input class="input" name="name" required />
        <button class="btn primary" type="submit">Save category</button>
      </form>
    </div>
  </div>

  <div class="modal-backdrop" id="addonModal">
    <div class="modal">
      <header><div class="font-semibold">Add add-on</div><button class="btn ghost" data-close="addonModal">✕</button></header>
      <form id="addonForm">
        <div class="label">Label</div>
        <input class="input" name="name" required />
        <div class="label">Price</div>
        <input class="input" name="price" type="number" step="0.01" required />
        <div class="label">Attach to item</div>
        <select class="input" name="item_id" id="addonItemSelect" required></select>
        <button class="btn primary" type="submit">Save add-on</button>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <script type="module">
    import { renderSidebar, showToast, mountThemeToggle } from "../js/ui.js";
    import { requireAuth, getClient } from "../js/auth.js";
    import {
      fetchMenu,
      updateMenuItem,
      insertMenuItem,
      insertCategory,
      updateCategory,
      fetchAddons,
      insertAddon,
      deleteAddon,
    } from "../js/api.js";
	    import { fmtMoney } from "../js/utils.js";
	    import { mountNotifications } from "../js/notifications_ui.js";
	    import { menuImageUrl, uploadMenuImageFile } from "../js/storage.js";
	    import {
	      initBranchState,
	      registerBranchSwitcher,
      getSelectedBranchId,
      getBranchLabel,
      onBranchChange,
    } from "../js/branches.js";

    renderSidebar("menu.html");
    mountThemeToggle();
    const { profile } = await requireAuth();
    mountNotifications({ supabase: getClient() });
    await initBranchState({ role: profile.role, profileBranchId: profile.branch_id });
    registerBranchSwitcher(document.getElementById("branchSwitcherSelect"), {
      allowAll: profile.role === "super_admin",
    });
    onBranchChange(() => loadData());

    const catList = document.getElementById("catList");
    const filterCategory = document.getElementById("filterCategory");
    const itemsTbody = document.querySelector("#itemsTable tbody");
    const searchInput = document.getElementById("searchInput");
	    const filterAvailability = document.getElementById("filterAvailability");
	    const itemModal = document.getElementById("itemModal");
	    const categoryModal = document.getElementById("categoryModal");
	    const addonModal = document.getElementById("addonModal");
	    const itemForm = document.getElementById("itemForm");
	    const itemImageFile = document.getElementById("itemImageFile");
	    const itemImagePreview = document.getElementById("itemImagePreview");
	    const itemImagePreviewImg = document.getElementById("itemImagePreviewImg");
	    const clearItemImageBtn = document.getElementById("clearItemImage");
	    let categories = [];
	    let items = [];
	    let addons = [];
	    let editingItemId = null;
	    let editingItemBranchId = null;
	    let selectedImageObjectUrl = null;

	    document.getElementById("reloadMenu").addEventListener("click", loadData);
	    document.getElementById("refreshAddons").addEventListener("click", loadAddons);
	    document.getElementById("addItemBtn").addEventListener("click", () => openItemModal());
	    document.getElementById("addCategoryBtn").addEventListener("click", () => toggleModal(categoryModal, true));
	    document.getElementById("addAddonBtn").addEventListener("click", () => toggleModal(addonModal, true));
	    document.querySelectorAll("[data-close]").forEach((btn) => btn.addEventListener("click", () => toggleModal(document.getElementById(btn.dataset.close), false)));
	    searchInput.addEventListener("input", renderItems);
	    filterCategory.addEventListener("change", renderItems);
	    filterAvailability.addEventListener("change", renderItems);

	    itemImageFile.addEventListener("change", () => {
	      const f = itemImageFile.files?.[0];
	      if (!f) return;
	      if (selectedImageObjectUrl) URL.revokeObjectURL(selectedImageObjectUrl);
	      selectedImageObjectUrl = URL.createObjectURL(f);
	      itemImagePreviewImg.src = selectedImageObjectUrl;
	      itemImagePreview.style.display = "flex";
	    });

	    clearItemImageBtn.addEventListener("click", () => {
	      itemForm.querySelector("[name=image_url]").value = "";
	      itemImageFile.value = "";
	      if (selectedImageObjectUrl) URL.revokeObjectURL(selectedImageObjectUrl);
	      selectedImageObjectUrl = null;
	      itemImagePreviewImg.removeAttribute("src");
	      itemImagePreview.style.display = "none";
	    });

	    itemForm.addEventListener("submit", async (e) => {
	      e.preventDefault();
	      const rawBranch = getSelectedBranchId();
	      const branchId = rawBranch && rawBranch !== "all" ? rawBranch : null;
	      if (!branchId && !editingItemId) return showToast("Select a branch before adding items");
	      const fd = new FormData(e.target);
	      const payload = Object.fromEntries(fd.entries());
	      const id = String(payload.id || "").trim() || null;
	      delete payload.id;
	      payload.base_price = Number(payload.base_price || 0);
	      payload.is_sold_out = fd.get("is_sold_out") === "on";

	      const file = itemImageFile.files?.[0] || null;
	      const urlField = String(payload.image_url || "").trim();
	      payload.image_url = urlField ? urlField : null;

	      const isEdit = Boolean(id);
	      let itemId = id;
	      const uploadBranchId = isEdit ? editingItemBranchId : branchId;
	      if (!uploadBranchId) return showToast("Select a branch");

	      // Insert first (to get an id) then upload (if any) and update image_url with the storage path.
	      if (!isEdit) {
	        payload.branch_id = branchId;
	        const created = await insertMenuItem(payload);
	        if (created.error) return showToast(created.error.message);
	        itemId = created.data?.id;
	        showToast("Item added");
	      } else {
	        delete payload.branch_id;
	        const res = await updateMenuItem(itemId, payload);
	        if (res.error) return showToast(res.error.message);
	        showToast("Item updated");
	      }

	      if (file) {
	        const up = await uploadMenuImageFile({ file, branchId: uploadBranchId, itemId });
	        if (up.error) return showToast(up.error.message);
	        const u = await updateMenuItem(itemId, { image_url: up.data.path });
	        if (u.error) return showToast(u.error.message);
	      }

	      toggleModal(itemModal, false);
	      e.target.reset();
	      editingItemId = null;
	      editingItemBranchId = null;
	      itemImageFile.value = "";
	      if (selectedImageObjectUrl) URL.revokeObjectURL(selectedImageObjectUrl);
	      selectedImageObjectUrl = null;
	      itemImagePreview.style.display = "none";
	      await loadData();
	    });

    document.getElementById("categoryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const rawBranch = getSelectedBranchId();
      const branchId = rawBranch && rawBranch !== "all" ? rawBranch : null;
      if (!branchId) return showToast("Select a branch before adding categories");
      const name = new FormData(e.target).get("name");
      const nextOrder = categories.length ? Math.max(...categories.map((c) => c.sort_order || 0)) + 1 : 0;
      const { error } = await insertCategory({ name, sort_order: nextOrder, branch_id: branchId });
      if (error) return showToast(error.message);
      showToast("Category added");
      toggleModal(categoryModal, false);
      e.target.reset();
      await loadData();
    });

    document.getElementById("addonForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const rawBranch = getSelectedBranchId();
      const branchId = rawBranch && rawBranch !== "all" ? rawBranch : null;
      if (!branchId) return showToast("Select a branch before adding add-ons");
      const fd = new FormData(e.target);
      const payload = {
        name: fd.get("name"),
        price: Number(fd.get("price") || 0),
        item_id: fd.get("item_id"),
        branch_id: branchId,
      };
      const { error } = await insertAddon(payload);
      if (error) return showToast(error.message);
      showToast("Add-on saved");
      toggleModal(addonModal, false);
      e.target.reset();
      await loadAddons();
    });

	    function toggleModal(el, show) {
	      el.classList[show ? "add" : "remove"]("show");
	    }

	    function openItemModal(item = null) {
	      const rawBranch = getSelectedBranchId();
	      const branchId = rawBranch && rawBranch !== "all" ? rawBranch : null;
	      if (!branchId && !item?.branch_id) return showToast("Select a branch first");

	      itemForm.reset();
	      editingItemId = item?.id || null;
	      editingItemBranchId = item?.branch_id || branchId;
	      itemForm.querySelector("[name=id]").value = editingItemId || "";
	      document.getElementById("itemModalTitle").textContent = editingItemId ? "Edit item" : "Add item";

	      if (item) {
	        itemForm.querySelector("[name=name]").value = item.name || "";
	        itemForm.querySelector("[name=description]").value = item.description || "";
	        itemForm.querySelector("[name=category_id]").value = item.category_id || "";
	        itemForm.querySelector("[name=base_price]").value = item.base_price ?? 0;
	        itemForm.querySelector("[name=is_sold_out]").checked = Boolean(item.is_sold_out);
	        itemForm.querySelector("[name=image_url]").value = item.image_url || "";
	      }

	      // Preview existing image (URL or storage path).
	      const existingUrl = item?.image_url ? menuImageUrl(item.image_url) : "";
	      if (existingUrl) {
	        itemImagePreviewImg.src = existingUrl;
	        itemImagePreview.style.display = "flex";
	      } else {
	        itemImagePreview.style.display = "none";
	      }
	      itemImageFile.value = "";
	      if (selectedImageObjectUrl) URL.revokeObjectURL(selectedImageObjectUrl);
	      selectedImageObjectUrl = null;

	      toggleModal(itemModal, true);
	    }

	    loadData();

    async function loadData() {
      const rawBranch = getSelectedBranchId();
      const branchId = rawBranch && rawBranch !== "all" ? rawBranch : null;
      catList.innerHTML = `<div class="skeleton" style="height:24px;"></div>`;
      itemsTbody.innerHTML = `<tr><td colspan="6"><div class="skeleton" style="height:32px;"></div></td></tr>`;
      const { cats, items: it } = await fetchMenu({ branchId });
      if (cats.error) { catList.innerHTML = `<div class="muted">Error: ${cats.error.message}</div>`; return; }
      if (it.error) { itemsTbody.innerHTML = `<tr><td colspan="6" class="muted">Error: ${it.error.message}</td></tr>`; return; }
      categories = cats.data || [];
      items = it.data || [];
      renderCategories();
      renderItems();
      loadAddons();
    }

    function renderCategories() {
      filterCategory.innerHTML = `<option value=\"\">All categories</option>` + categories.map(c=>`<option value=\"${c.id}\">${c.name}</option>`).join("");
      const counts = items.reduce((acc, it) => {
        acc[it.category_id] = (acc[it.category_id] || 0) + 1;
        return acc;
      }, {});
      catList.innerHTML = categories
        .map(
          (c, idx) => `
          <div class="card" style="padding:10px; box-shadow:none; border:1px solid var(--color-border); display:flex; align-items:center; gap:8px;">
            <button class="btn ghost" data-move="${idx}" data-dir="-1">↑</button>
            <button class="btn ghost" data-move="${idx}" data-dir="1">↓</button>
            <div style="flex:1;">
              <div class="font-semibold">${c.name}</div>
              <div class="muted text-sm">${counts[c.id] || 0} items</div>
            </div>
            <label class="chip-btn ${c.is_active ? "active" : ""}" data-cat="${c.id}" data-toggle="active">${c.is_active ? "Active" : "Hidden"}</label>
          </div>`
        )
        .join("");
      catList.querySelectorAll("[data-toggle]").forEach((btn) =>
        btn.addEventListener("click", async () => {
          const id = btn.dataset.cat;
          const cat = categories.find((c) => c.id === id);
          const { error } = await updateCategory(id, { is_active: !cat.is_active });
          if (error) return showToast(error.message);
          showToast("Category updated");
          loadData();
        })
      );
      catList.querySelectorAll("[data-move]").forEach((btn) =>
        btn.addEventListener("click", async () => {
          const idx = Number(btn.dataset.move);
          const dir = Number(btn.dataset.dir);
          const target = idx + dir;
          if (target < 0 || target >= categories.length) return;
          const arr = [...categories];
          [arr[idx], arr[target]] = [arr[target], arr[idx]];
          await Promise.all(
            arr.map((c, i) => updateCategory(c.id, { sort_order: i }))
          );
          showToast("Order saved");
          loadData();
        })
      );
      // fill modal select
      document.getElementById("itemCatSelect").innerHTML = categories.map((c) => `<option value="${c.id}">${c.name}</option>`).join("");
    }

    function renderItems() {
      const rawBranch = getSelectedBranchId();
      let filtered = [...items];
      const q = searchInput.value.trim().toLowerCase();
      if (q) filtered = filtered.filter((i) => i.name.toLowerCase().includes(q));
      const cat = filterCategory.value;
      if (cat) filtered = filtered.filter((i) => i.category_id === cat);
      const avail = filterAvailability.value;
      if (avail === "available") filtered = filtered.filter((i) => !i.is_sold_out && i.is_active);
      if (avail === "soldout") filtered = filtered.filter((i) => i.is_sold_out);
      if (avail === "inactive") filtered = filtered.filter((i) => !i.is_active);
      if (!filtered.length) {
        itemsTbody.innerHTML = `<tr><td colspan="6" class="muted">No items match</td></tr>`;
        return;
      }
	      itemsTbody.innerHTML = filtered
	        .map((m) => {
	          const catName = categories.find((c) => c.id === m.category_id)?.name || "Uncategorized";
	          const branchChip =
	            rawBranch === "all" ? `<span class="branch-badge">${getBranchLabel(m.branch_id)}</span>` : "";
	          const imgUrl = m.image_url ? menuImageUrl(m.image_url) : "";
	          return `
	          <tr>
	            <td>
	              <div class="flex-between" style="gap:8px;">
	                ${imgUrl ? `<img src="${imgUrl}" alt="" style="width:48px; height:48px; object-fit:cover; border-radius:10px;">` : ""}
	                <div>
	                  <div class="font-semibold">${branchChip}${m.name}</div>
	                  <div class="muted text-sm">${m.description || ""}</div>
	                </div>
	              </div>
	            </td>
	            <td>${catName}</td>
            <td>
              <input data-price="${m.id}" type="number" step="0.01" value="${m.base_price}" style="width:100px; border:1px solid var(--color-border); border-radius:8px; padding:4px 6px;">
            </td>
	            <td><button class="chip-btn" data-available="${m.id}">${m.is_sold_out ? "Sold out" : "Available"}</button></td>
	            <td><button class="chip-btn ${m.is_active ? "active" : ""}" data-active="${m.id}">${m.is_active ? "Active" : "Hidden"}</button></td>
	            <td style="display:flex; gap:8px; justify-content:flex-end;">
	              <button class="btn ghost" data-edit="${m.id}">Edit</button>
	              <button class="btn ghost" data-delete="${m.id}">Delete</button>
	            </td>
	          </tr>`;
	        })
	        .join("");

      itemsTbody.querySelectorAll("[data-price]").forEach((input) =>
        input.addEventListener("change", async () => {
          const id = input.dataset.price;
          const { error } = await updateMenuItem(id, { base_price: Number(input.value || 0) });
          if (error) return showToast(error.message);
          showToast("Price updated");
          loadData();
        })
      );
      itemsTbody.querySelectorAll("[data-available]").forEach((btn) =>
        btn.addEventListener("click", async () => {
          const id = btn.dataset.available;
          const item = items.find((i) => i.id === id);
          const { error } = await updateMenuItem(id, { is_sold_out: !item.is_sold_out });
          if (error) return showToast(error.message);
          showToast("Availability updated");
          loadData();
        })
      );
      itemsTbody.querySelectorAll("[data-active]").forEach((btn) =>
        btn.addEventListener("click", async () => {
          const id = btn.dataset.active;
          const item = items.find((i) => i.id === id);
          const { error } = await updateMenuItem(id, { is_active: !item.is_active });
          if (error) return showToast(error.message);
          showToast("Visibility updated");
          loadData();
        })
      );
	      itemsTbody.querySelectorAll("[data-delete]").forEach((btn) =>
	        btn.addEventListener("click", async () => {
	          if (!confirm("Delete this item?")) return;
	          const { error } = await updateMenuItem(btn.dataset.delete, { is_active: false });
	          if (error) return showToast(error.message);
	          showToast("Item hidden");
	          loadData();
	        })
	      );

	      itemsTbody.querySelectorAll("[data-edit]").forEach((btn) =>
	        btn.addEventListener("click", () => {
	          const id = btn.dataset.edit;
	          const item = items.find((i) => i.id === id);
	          if (!item) return;
	          openItemModal(item);
	        })
	      );

      // add-on item select
      const addonSelect = document.getElementById("addonItemSelect");
      addonSelect.innerHTML = items.map((i) => `<option value="${i.id}">${i.name}</option>`).join("");
    }

    async function loadAddons() {
      const rawBranch = getSelectedBranchId();
      const branchId = rawBranch && rawBranch !== "all" ? rawBranch : null;
      const list = document.getElementById("addonList");
      list.innerHTML = `<div class="skeleton" style="height:24px;"></div>`;
      const { data, error } = await fetchAddons({ branchId });
      if (error) { list.innerHTML = `<div class="muted">Error: ${error.message}</div>`; return; }
      addons = data || [];
      if (!addons.length) { list.innerHTML = `<div class="muted text-sm">No add-ons yet</div>`; return; }
      const itemMap = new Map(items.map((i) => [i.id, i.name]));
      list.innerHTML = addons
        .map(
          (a) => `
        <div class="card" style="padding:10px; box-shadow:none; border:1px solid var(--color-border); display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div class="font-semibold">${a.name}</div>
            <div class="muted text-sm">${fmtMoney(a.price)} • ${itemMap.get(a.item_id) || "Item deleted"}</div>
          </div>
          <button class="btn ghost" data-del-addon="${a.id}">Delete</button>
        </div>`
        )
        .join("");
      list.querySelectorAll("[data-del-addon]").forEach((btn) =>
        btn.addEventListener("click", async () => {
          if (!confirm("Delete add-on?")) return;
          const { error } = await deleteAddon(btn.dataset.delAddon);
          if (error) return showToast(error.message);
          showToast("Add-on deleted");
          loadAddons();
        })
      );
    }
  </script>
</body>
</html>

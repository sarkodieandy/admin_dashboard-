<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Delivery Settings â€¢ Finger Licking Admin</title>
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <script src="../env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">Finger Licking</div>
      <div class="nav"></div>
    </aside>
    <main>
      <div class="topbar">
        <div>
          <div class="font-bold">Delivery Settings</div>
          <div class="muted" style="font-size: var(--text-sm)">Fees & limits</div>
        </div>
      </div>
      <div class="page">
        <div class="card">
          <div class="grid" style="display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <label style="display:flex; flex-direction:column; gap:6px;">
              <span class="muted text-sm">Base fee</span>
              <input data-field="base_fee" type="number" step="0.01" class="input" />
            </label>
            <label style="display:flex; flex-direction:column; gap:6px;">
              <span class="muted text-sm">Free radius (km)</span>
              <input data-field="free_radius_km" type="number" step="0.1" class="input" />
            </label>
            <label style="display:flex; flex-direction:column; gap:6px;">
              <span class="muted text-sm">Per km after free radius</span>
              <input data-field="per_km_fee_after_free_radius" type="number" step="0.01" class="input" />
            </label>
            <label style="display:flex; flex-direction:column; gap:6px;">
              <span class="muted text-sm">Minimum order amount</span>
              <input data-field="minimum_order_amount" type="number" step="0.01" class="input" />
            </label>
            <label style="display:flex; flex-direction:column; gap:6px;">
              <span class="muted text-sm">Max delivery distance (km)</span>
              <input data-field="max_delivery_distance_km" type="number" step="0.1" class="input" />
            </label>
          </div>
          <button id="saveBtn" class="btn primary" style="margin-top:12px;">Save</button>
          <div id="status" class="muted text-sm" style="margin-top:6px;"></div>
        </div>
      </div>
    </main>
  </div>
  <div id="toast" class="toast"></div>
  <script type="module">
    import { renderSidebar, showToast, mountThemeToggle } from "../js/ui.js";
    import { requireAuth } from "../js/auth.js";
    import { loadDeliverySettings, saveDeliverySettings } from "../js/api.js";

    renderSidebar("delivery-settings.html");
    mountThemeToggle();
    await requireAuth();
    load();
    document.getElementById("saveBtn").addEventListener("click", save);

    async function load() {
      const status = document.getElementById("status");
      status.textContent = "Loading...";
      const { data, error } = await loadDeliverySettings();
      if (error) { status.textContent = error.message; return; }
      if (data) {
        document.querySelectorAll("[data-field]").forEach(inp => inp.value = data[inp.dataset.field] ?? "");
        status.textContent = "Loaded.";
      } else status.textContent = "No settings yet.";
    }
    async function save() {
      const payload = {};
      document.querySelectorAll("[data-field]").forEach(inp => payload[inp.dataset.field] = Number(inp.value||0));
      const { error } = await saveDeliverySettings(payload);
      if (error) { showToast(error.message); return; }
      showToast("Saved");
      load();
    }
  </script>
</body>
</html>
